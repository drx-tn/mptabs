<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Tableaux des maladies professionnelles en Tunisie</title>
	<link rel="icon" type="image/png" href="mptabs.png" />
	<link rel="manifest" href="manifest.webmanifest">
	<!-- UIkit CSS -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.24.2/dist/css/uikit.min.css" />
	<style>
		.uk-lightbox-items > * {
			overflow: auto !important;
			-webkit-overflow-scrolling: touch !important;
			touch-action: pan-x pan-y;
		}
		.uk-lightbox-iframe {
			touch-action: pan-x pan-y;
		}
	</style>
</head>
<body>
	<div uk-sticky="top">
		<div id="install-banner" class="uk-alert-primary uk-padding-small uk-margin-remove" uk-alert hidden>
			<div class="uk-grid-small uk-flex-middle" uk-grid>
				<div class="uk-width-auto"><span uk-icon="icon: download; ratio: 1.5"></span></div>
				<div class="uk-width-expand uk-text-center uk-text-left@s">
					<span class="uk-text-bold">MPTabs est installable !</span>
					<span> Installez-la pour un accès rapide et hors ligne.</span>
				</div>
				<div class="uk-width-1-1 uk-width-auto@s uk-text-center">
					<button id="install-button" class="uk-button uk-button-primary uk-button-small">Installer</button>
					<a class="uk-button uk-button-default uk-button-small" href="#close-banner-modal" uk-toggle>Plus tard</a>
				</div>
			</div>
		</div>
	</div>
	<div id="close-banner-modal" uk-modal>
		<div class="uk-modal-dialog" uk-overflow-auto>
			<div class="uk-modal-header">
				<h2 class="uk-modal-title">Rappel d'installation</h2>
			</div>
			<div class="uk-modal-body">
				<p>Voulez-vous avoir un message de rappel pour l'installation?</p>
				<div class="uk-form-controls uk-margin">
					<label class="uk-margin-small-right"><input class="uk-radio" type="radio" name="reminder-option" value="next-time" checked> La prochaine fois</label>
				</div>
				<div class="uk-form-controls uk-margin">
					<label><input class="uk-radio" type="radio" name="reminder-option" value="24h"> Dans 24 heures</label>
				</div>
				<div class="uk-form-controls">
					<label><input class="uk-radio" type="radio" name="reminder-option" value="never"> Ne jamais rappeler</label>
				</div>
			</div>
			<div class="uk-modal-footer uk-text-right">
				<button class="uk-button uk-button-default uk-modal-close" type="button">Annuler</button>
				<button class="uk-button uk-button-primary" id="confirm-reminder-choice" type="button">Valider</button>
			</div>
		</div>
	</div>
	<div id="filter" uk-offcanvas="mode: slide; overlay: true; flip: true; esc-close: true; bg-close: true">
		<div class="uk-offcanvas-bar">
			<button class="uk-offcanvas-close" type="button" uk-close></button>
			<ul class="uk-nav-default uk-nav-parent-icon" uk-nav id="manifs">
				<li><a href="javascript:void(0)" id="allmp">Toutes les manifestations</a></li>
			</ul>
		</div>
	</div>
	<div id="about" uk-modal>
    	<div class="uk-modal-dialog uk-animation-shake">
			<button class="uk-modal-close-default" type="button" uk-close></button>
			<div class="uk-modal-header">
				<h2 class="uk-modal-title">MPTabs</h2>
			</div>
			<div class="uk-modal-body" uk-overflow-auto>
				<ul uk-tab>
				    <li><a href="#">L'application</a></li>
    				<li><a href="#">L'auteur</a></li>
				</ul>
				<ul class="uk-switcher uk-margin">
    				<li>
						<img src="mptabs.png" class="uk-align-left uk-margin-remove-adjacent" width="96" height="96" alt="MPTabs">
						<p>MPTabs est une application qui permet de consulter rapidement les tableaux des maladies professionnelles en Tunisie. Elle s'inspire et utilise des documents publiés par l'Institut de Santé et de Sécurité au Travail.</p>
						<p>Plus d'infos sur: <em><a href="http://drx.tn" target="_blank">drx.tn</a></em></p>
					</li>
    				<li>
						<img src="profile.png" class="uk-align-left uk-margin-remove-adjacent" width="96" height="145" alt="Dr. Nizar Ben Ltaief">
						<p>MPTabs a été développée par moi, Dr. Nizar Ben Ltaief, médecin à plein temps au Groupement de Médecine du Travail du Gouvernorat de Sousse, développeur amateur et fervent défenseur du libre.</p>
						<p>Pour me contacter: <em><a href="mailto:contact@drx.tn">contact@drx.tn</a></em></p>
					</li>
				</ul>
			</div>
			<div class="uk-modal-footer">
				<p class="uk-text-right"><button class="uk-button uk-button-primary uk-modal-close" type="button">Fermer</button></p>
			</div>
    	</div>
	</div>
	<nav class="uk-navbar-container uk-navbar-transparent uk-margin uk-margin-right" uk-navbar>
		<div class="nav-overlay uk-navbar-right uk-flex-1" hidden>
			<div class="uk-navbar-item uk-width-expand">
				<form class="uk-search uk-search-navbar uk-width-1-1" action="javascript:void(0)">
					<input id="searchbox" class="uk-search-input" type="search" placeholder="Rechercher" aria-label="Search" autofocus>
				</form>
			</div>
			<a id="togglesearch" class="uk-navbar-toggle" uk-close uk-toggle="target: .nav-overlay; animation: uk-animation-fade" href="#"></a>
		</div>
		<div class="nav-overlay uk-navbar-right">
				<a class="uk-navbar-toggle" uk-search-icon uk-toggle="target: .nav-overlay; animation: uk-animation-fade" href="#"></a>
				<ul class="uk-navbar-nav">
            		<li><a href="#filter" id="switch" uk-toggle><span uk-icon="icon: cog"></span> Filtrer</a></li>
        			<li><a href="#about" id="about" uk-toggle><span uk-icon="icon: info"></span> À propos</a></li>
        		<ul>
		</div>
	</nav>
	<div class="uk-container uk-container-center uk-width-1-2@s">
		<ul uk-nav id="mps"></ul>
	</div>
	</br>
	<!-- UIkit JS -->
	<script src="https://cdn.jsdelivr.net/npm/uikit@3.24.2/dist/js/uikit.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/uikit@3.24.2/dist/js/uikit-icons.min.js"></script>
	<!-- FlexSearch JS -->
	<script src="https://cdn.jsdelivr.net/gh/nextapps-de/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>
	<!-- Main thing -->
	<script>
		window.addEventListener('load', function () {
			if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js', {scope: '/mptabs/'});
		});
		var filterState = false;
		(function () {
			fetch("inc/data.json")
				.then(function(response) { return response.json(); })
				.then(function(data) {
				var manifs = document.querySelector("#manifs");
				for (var i = 0; i < data.manifs.length; i++) {
					manif = document.createElement("li");
					manif.setAttribute("class","uk-parent");
					manif.innerHTML = '<a>'+data.manifs[i].group+'</a>';
					items = document.createElement("ul");
					items.setAttribute("class","uk-nav-sub");
					for (var j = 0; j < data.manifs[i].items.length; j ++) {
						item = document.createElement("li");
						item.innerHTML = '<a class="mptabs" data-mptabs="'+data.manifs[i].items[j].tabs+'">'+data.manifs[i].items[j].manif+'</a>';
						items.appendChild(item);
					}
					manif.appendChild(items);
					manifs.appendChild(manif);
				}
				var mps = document.querySelector("#mps");
				for (var i = 0; i < data.mps.length; i++) {
					mp = document.createElement("li");
					mp.setAttribute("class","mptab");
					mp.setAttribute("id", data.mps[i].id);
					mp.innerHTML = '<div uk-lightbox><a data-type="iframe" href="inc/tab.html?i='+i+'">'+data.mps[i].name+'</a></div>';
					mps.appendChild(mp);
				}
				document.getElementById("allmp").addEventListener("click", function () {
					[].forEach.call(document.querySelectorAll(".mptab"), function (mptab) { mptab.style.display = ""; });
				});
				const index = new FlexSearch.Document({
					document: {
						id: "id",
						index: ["fulltext"]
					},
					tokenize: "full"
				});
				data.mps.forEach(mp_item => {
					index.add(mp_item);
				});
				document.getElementById("searchbox").addEventListener('input', function () {
					const terms = this.value;
					if (terms.length > 1) {
						const results = index.search(terms, { 
							field: "fulltext",
							limit: 87
						});
						[].forEach.call(document.querySelectorAll(".mptab"), function (mptab) {
							mptab.style.display = "none";
						});
						if (results.length > 0) {
							const matchingIds = new Set();
							results.forEach(resultSet => {
								resultSet.result.forEach(id => {
									matchingIds.add(id);
								});
							});
							matchingIds.forEach(id => {
								const element = document.getElementById(id);
								if (element) { element.style.display = ""; }
							});
						}
					} else {
						[].forEach.call(document.querySelectorAll(".mptab"), function (mptab) {
							mptab.style.display = "";
						});
					}
				});
				document.getElementById("togglesearch").addEventListener('mousedown', function (){
					document.getElementById("searchbox").value = "";
					[].forEach.call(document.querySelectorAll(".mptab"), function (mptab) { mptab.style.display = ""; });
				});
				Array.from(document.getElementsByClassName("mptabs")).forEach(function (e) {
					e.addEventListener("click", function () {
						[].forEach.call(document.querySelectorAll(".mptab"), function (mptab) { mptab.style.display = "none"; });
						[].forEach.call(document.querySelectorAll(this.dataset.mptabs), function (mptab) { mptab.style.display = ""; });
					});
				});
			});
		})();
		let deferredPrompt;
		const installBanner = document.getElementById('install-banner');
		const installButton = document.getElementById('install-button');
		document.getElementById('confirm-reminder-choice').addEventListener('click', () => {
			const selectedOption = document.querySelector('input[name="reminder-option"]:checked');
			
			if (selectedOption) {
				const choice = selectedOption.value;
				switch (choice) {
					case '24h':
						localStorage.setItem('installBannerClosed', Date.now());
						break;
					case 'never':
						localStorage.setItem('installBannerNever', 'true');
						break;
				}
			}

			installBanner.hidden = true;
			UIkit.modal('#close-banner-modal').hide();
		});
		window.addEventListener('beforeinstallprompt', (e) => {
			e.preventDefault();
			deferredPrompt = e;
			if (localStorage.getItem('installBannerNever') === 'true') {
				return;
			}
			const lastClosed = localStorage.getItem('installBannerClosed');
			if (lastClosed && (Date.now() - lastClosed < 24 * 60 * 60 * 1000)) {
				return;
			}
			installBanner.hidden = false;
		});
		installButton.addEventListener('click', async () => {
			if (deferredPrompt) {
				deferredPrompt.prompt();
				const { outcome } = await deferredPrompt.userChoice;
				deferredPrompt = null;
				installBanner.hidden = true;
			}
		});
		window.addEventListener('appinstalled', () => {
			installBanner.hidden = true;
			localStorage.setItem('installBannerNever', 'true');
		});

		if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
			installBanner.hidden = true;
		}
	</script>
</body>
</html>